# v1.6.0 Feature: Server-LÃ¶sch-EinschrÃ¤nkung im Offline-Modus

## ğŸ“‹ Ãœbersicht

**Problem:** Im Offline-Modus kann der Benutzer immer noch "Ãœberall lÃ¶schen (auch Server)" auswÃ¤hlen, was zu Netzwerkverkehr fÃ¼hrt (auch wenn die Anfrage fehlschlÃ¤gt).

**Ziel:** Die "Ãœberall lÃ¶schen"-Option im Offline-Modus subtil aber intuitiv deaktivieren, um echte Offline-Nutzung zu gewÃ¤hrleisten.

---

## ğŸ” Analyse der betroffenen Komponenten

### 1. DeleteConfirmationDialog
**Datei:** [DeleteConfirmationDialog.kt](../android/app/src/main/java/dev/dettmer/simplenotes/ui/main/components/DeleteConfirmationDialog.kt)

**Aktueller Zustand:**
- Zeigt zwei Optionen: "Ãœberall lÃ¶schen" und "Nur lokal lÃ¶schen"
- Keine BerÃ¼cksichtigung des Offline-Modus
- Verwendet in: `MainScreen.kt` (Batch-Delete) und `NoteEditorScreen.kt` (Einzelne Notiz)

**Ã„nderungen:**
- Neuer Parameter: `isOfflineMode: Boolean = false`
- "Ãœberall lÃ¶schen" Button: `enabled = !isOfflineMode`
- Subtile visuelle Kennzeichnung wenn deaktiviert

### 2. Verwendungsstellen

| Datei | Verwendung | ViewModel-Zugriff |
|-------|------------|-------------------|
| `MainScreen.kt` | Batch-LÃ¶schung | `MainViewModel.isOfflineMode` âœ… bereits vorhanden |
| `NoteEditorScreen.kt` | Einzelne Notiz | `NoteEditorViewModel` âŒ benÃ¶tigt Erweiterung |

### 3. NoteEditorViewModel
**Datei:** [NoteEditorViewModel.kt](../android/app/src/main/java/dev/dettmer/simplenotes/ui/editor/NoteEditorViewModel.kt)

**Aktueller Zustand:**
- PrÃ¼ft Offline-Status nur fÃ¼r `triggerOnSaveSync()` inline via `prefs.getString(KEY_SERVER_URL, null)`
- Kein reaktiver State fÃ¼r Offline-Modus

**Ã„nderungen:**
- Neuer StateFlow: `isOfflineMode: StateFlow<Boolean>`

---

## ğŸ“ Technische Design-Entscheidungen

### UI/UX Design fÃ¼r deaktivierte Option

#### Option A: Grayed-out mit Tooltip-Hinweis âœ… **EMPFOHLEN**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Notiz lÃ¶schen?                         â”‚
â”‚                                         â”‚
â”‚  Wie mÃ¶chtest du diese Notiz lÃ¶schen?   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Ãœberall lÃ¶schen (auch Server)       â”‚â”‚ â† Grau, nicht anklickbar
â”‚  â”‚ ğŸ“´ Nicht verfÃ¼gbar im Offline-Modus â”‚â”‚ â† Subtiler Hinweis
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ âœ“ Nur lokal lÃ¶schen                 â”‚â”‚ â† Normal, anklickbar
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     Abbrechen                       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Vorteile:**
- Konsistent mit bestehendem v1.6.0 Pattern (BackupSettingsScreen, MarkdownSettingsScreen)
- Benutzer sieht sofort warum Option nicht verfÃ¼gbar
- Keine Verwirrung - klare Ursache angegeben

#### Option B: Button komplett ausblenden âŒ
**Nachteile:**
- Verwirrend fÃ¼r Benutzer die den Button sonst sehen
- Inkonsistent mit v1.6.0 Design-Pattern

#### Option C: Button mit Toast-Feedback âŒ
**Nachteile:**
- Schlechte UX - warum klickbar wenn nicht mÃ¶glich?
- Frustierend fÃ¼r Benutzer

---

## ğŸ“ Implementierungs-Plan

### Phase 1: DeleteConfirmationDialog erweitern

**Schritt 1.1:** Neuer Parameter und String-Ressourcen

```kotlin
// DeleteConfirmationDialog.kt
@Composable
fun DeleteConfirmationDialog(
    noteCount: Int = 1,
    isOfflineMode: Boolean = false,  // ğŸŒŸ v1.6.0: NEU
    onDismiss: () -> Unit,
    onDeleteLocal: () -> Unit,
    onDeleteEverywhere: () -> Unit
)
```

**Neue Strings:**
```xml
<!-- values/strings.xml -->
<string name="delete_everywhere_offline_hint">Not available in offline mode</string>

<!-- values-de/strings.xml -->
<string name="delete_everywhere_offline_hint">Nicht verfÃ¼gbar im Offline-Modus</string>
```

**Schritt 1.2:** UI-Anpassung fÃ¼r deaktivierten Button

```kotlin
// Delete everywhere (server + local) - primary action
// ğŸŒŸ v1.6.0: Disabled in offline mode
Column {
    TextButton(
        onClick = onDeleteEverywhere,
        modifier = Modifier.fillMaxWidth(),
        enabled = !isOfflineMode,  // ğŸŒŸ NEU
        colors = ButtonDefaults.textButtonColors(
            contentColor = MaterialTheme.colorScheme.error,
            disabledContentColor = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.38f)
        )
    ) {
        Text(stringResource(R.string.delete_everywhere))
    }
    
    // ğŸŒŸ v1.6.0: Show hint when offline
    if (isOfflineMode) {
        Text(
            text = stringResource(R.string.delete_everywhere_offline_hint),
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.tertiary,
            modifier = Modifier.padding(start = 16.dp, end = 16.dp, bottom = 8.dp)
        )
    }
}
```

### Phase 2: MainScreen anpassen (Batch-LÃ¶schung)

**Datei:** `MainScreen.kt`

**Aktuelle Verwendung (Zeile ~218):**
```kotlin
DeleteConfirmationDialog(
    noteCount = selectedNotes.size,
    onDismiss = { showBatchDeleteDialog = false },
    onDeleteLocal = { ... },
    onDeleteEverywhere = { ... }
)
```

**Ã„nderung:**
```kotlin
DeleteConfirmationDialog(
    noteCount = selectedNotes.size,
    isOfflineMode = isOfflineMode,  // ğŸŒŸ v1.6.0: NEU - bereits als State vorhanden
    onDismiss = { showBatchDeleteDialog = false },
    onDeleteLocal = { ... },
    onDeleteEverywhere = { ... }
)
```

### Phase 3: NoteEditorScreen + NoteEditorViewModel anpassen

**Schritt 3.1:** NoteEditorViewModel erweitern

```kotlin
// NoteEditorViewModel.kt

// ğŸŒŸ v1.6.0: Offline Mode State
private val _isOfflineMode = MutableStateFlow(
    prefs.getBoolean(Constants.KEY_OFFLINE_MODE, true)
)
val isOfflineMode: StateFlow<Boolean> = _isOfflineMode.asStateFlow()
```

**Schritt 3.2:** NoteEditorScreen anpassen

```kotlin
// NoteEditorScreen.kt

// State abrufen
val isOfflineMode by viewModel.isOfflineMode.collectAsState()  // ğŸŒŸ NEU

// Dialog anpassen
if (showDeleteDialog) {
    DeleteConfirmationDialog(
        noteCount = 1,
        isOfflineMode = isOfflineMode,  // ğŸŒŸ v1.6.0: NEU
        onDismiss = { showDeleteDialog = false },
        onDeleteLocal = { ... },
        onDeleteEverywhere = { ... }
    )
}
```

---

## ğŸ”§ Detaillierte Ã„nderungs-Matrix

| Datei | Ã„nderungstyp | Beschreibung |
|-------|--------------|--------------|
| `strings.xml` | String hinzufÃ¼gen | `delete_everywhere_offline_hint` (EN) |
| `strings.xml` (de) | String hinzufÃ¼gen | `delete_everywhere_offline_hint` (DE) |
| `DeleteConfirmationDialog.kt` | Parameter + UI | `isOfflineMode` Parameter, grayed-out Button + Hint |
| `MainScreen.kt` | Parameter Ã¼bergeben | `isOfflineMode = isOfflineMode` an Dialog |
| `NoteEditorViewModel.kt` | StateFlow hinzufÃ¼gen | `isOfflineMode: StateFlow<Boolean>` |
| `NoteEditorScreen.kt` | State abrufen + Ã¼bergeben | collectAsState + an Dialog Ã¼bergeben |

---

## âœ… Akzeptanzkriterien

1. **Offline-Modus aktiv:**
   - [ ] "Ãœberall lÃ¶schen" Button ist grau/deaktiviert
   - [ ] Subtiler Hinweis-Text erscheint unter dem Button
   - [ ] Button ist nicht anklickbar
   - [ ] "Nur lokal lÃ¶schen" funktioniert normal
   - [ ] Kein Netzwerkverkehr bei LÃ¶sch-Aktionen

2. **Online-Modus (Offline-Modus deaktiviert):**
   - [ ] Beide Buttons funktionieren normal
   - [ ] Kein Hinweis-Text
   - [ ] Verhalten unverÃ¤ndert

3. **Konsistenz:**
   - [ ] UI-Pattern konsistent mit anderen v1.6.0 Offline-EinschrÃ¤nkungen
   - [ ] Farbgebung nutzt `MaterialTheme.colorScheme.tertiary` fÃ¼r Hints

4. **Stellen:**
   - [ ] MainScreen (Batch-LÃ¶schung mit Multi-Select)
   - [ ] NoteEditorScreen (Einzelne Notiz lÃ¶schen)

---

## ğŸ“Š GeschÃ¤tzter Aufwand

| Phase | Aufwand | Dateien |
|-------|---------|---------|
| Phase 1: Dialog | ~30 Min | 3 Dateien |
| Phase 2: MainScreen | ~10 Min | 1 Datei |
| Phase 3: NoteEditor | ~20 Min | 2 Dateien |
| **Gesamt** | **~1 Stunde** | **6 Dateien** |

---

## ğŸ§ª Test-Szenarien

### Szenario 1: Einzelne Notiz lÃ¶schen (Editor)
1. Offline-Modus aktivieren
2. Bestehende Notiz Ã¶ffnen
3. LÃ¶schen-Button klicken
4. **Erwartung:** "Ãœberall lÃ¶schen" grau, Hint sichtbar
5. "Nur lokal lÃ¶schen" funktioniert

### Szenario 2: Batch-LÃ¶schung (Main Screen)
1. Offline-Modus aktivieren
2. Mehrere Notizen auswÃ¤hlen (Long-Press + Tap)
3. Papierkorb-Icon klicken
4. **Erwartung:** "Ãœberall lÃ¶schen" grau, Hint sichtbar
5. "Nur lokal lÃ¶schen" funktioniert

### Szenario 3: Wechsel zwischen Modi
1. Im Offline-Modus Dialog Ã¶ffnen â†’ Button deaktiviert
2. Abbrechen, in Einstellungen Offline-Modus deaktivieren
3. ZurÃ¼ck, Dialog erneut Ã¶ffnen â†’ Button aktiviert

---

## ğŸ“Œ Implementierungs-Reihenfolge

```
1. â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ String-Ressourcen hinzufÃ¼gen   â”‚  â† Start hier
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
2. â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ DeleteConfirmationDialog.kt    â”‚  â† Kern-Ã„nderung
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
3. â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MainScreen.kt                  â”‚  â† Einfach (State vorhanden)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
4. â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ NoteEditorViewModel.kt         â”‚  â† StateFlow hinzufÃ¼gen
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
5. â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ NoteEditorScreen.kt            â”‚  â† State abrufen + Ã¼bergeben
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— AbhÃ¤ngigkeiten

- Keine externen AbhÃ¤ngigkeiten
- Nutzt bestehende v1.6.0 Offline-Mode Infrastruktur
- Konsistent mit Design-Pattern aus `MarkdownSettingsScreen.kt` und `BackupSettingsScreen.kt`

---

## ğŸ“ Hinweise

- Der `isOfflineMode` State in `MainViewModel` wird bereits reaktiv via `StateFlow` verwaltet
- `refreshOfflineModeState()` wird in `ComposeMainActivity.onResume()` aufgerufen
- Das gleiche Pattern wird in `NoteEditorViewModel` repliziert (einmalige Initialisierung ausreichend, da Editor-Lebenszyklus kurz ist)
