name: Build Android Production APK

on:
  push:
    branches: [ main ]  # Nur bei Push/Merge auf main triggern
  workflow_dispatch:  # Erm√∂glicht manuellen Trigger

permissions:
  contents: write  # Fuer Release-Erstellung erforderlich

jobs:
  build:
    name: Build Production APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Code auschecken
        uses: actions/checkout@v4
      
      - name: Java einrichten
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Semantic Versionsnummer aus build.gradle.kts extrahieren
        run: |
          # Version aus build.gradle.kts fuer F-Droid Kompatibilit√§t
          VERSION_NAME=$(grep "versionName = " android/app/build.gradle.kts | sed 's/.*versionName = "\(.*\)".*/\1/')
          VERSION_CODE=$(grep "versionCode = " android/app/build.gradle.kts | sed 's/.*versionCode = \([0-9]*\).*/\1/')
          
          # Semantische Versionierung (nicht datums-basiert)
          BUILD_NUMBER="$VERSION_CODE"
          
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "VERSION_TAG=v$VERSION_NAME" >> $GITHUB_ENV
          
          echo "üöÄ Baue Version: $VERSION_NAME (Code: $BUILD_NUMBER)"
      
      - name: Version aus build.gradle.kts verifizieren
        run: |
          echo "‚úÖ Verwende Version aus build.gradle.kts:"
          grep -E "versionCode|versionName" android/app/build.gradle.kts
      
      - name: Android Signing konfigurieren
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/simple-notes-release.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=simple-notes-release.jks" >> android/key.properties
          echo "‚úÖ Signing-Konfiguration erstellt"
      
      - name: Produktions-APK bauen (Standard + F-Droid Flavors)
        run: |
          cd android
          ./gradlew assembleStandardRelease assembleFdroidRelease --no-daemon --stacktrace
      
      - name: APK-Varianten mit Versionsnamen kopieren
        run: |
          mkdir -p apk-output
          
          # === Standard Flavor (mit Google Services) ===
          # Universal APK (funktioniert auf allen Geraeten)
          cp android/app/build/outputs/apk/standard/release/app-standard-universal-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-standard-universal.apk
          
          # ARM64 APK (moderne Ger√§te 2018+)
          cp android/app/build/outputs/apk/standard/release/app-standard-arm64-v8a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-standard-arm64-v8a.apk
          
          # ARMv7 APK (√§ltere Ger√§te)
          cp android/app/build/outputs/apk/standard/release/app-standard-armeabi-v7a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-standard-armeabi-v7a.apk
          
          # === F-Droid Flavor (ohne Google Services) ===
          # Universal APK
          cp android/app/build/outputs/apk/fdroid/release/app-fdroid-universal-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-universal.apk
          
          # ARM64 APK
          cp android/app/build/outputs/apk/fdroid/release/app-fdroid-arm64-v8a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-arm64-v8a.apk
          
          # ARMv7 APK
          cp android/app/build/outputs/apk/fdroid/release/app-fdroid-armeabi-v7a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-armeabi-v7a.apk
          
          echo "‚úÖ APK-Dateien vorbereitet (Standard + F-Droid):"
          ls -lh apk-output/
      
      - name: APK-Artefakte hochladen
        uses: actions/upload-artifact@v4
        with:
          name: simple-notes-sync-apks-v${{ env.VERSION_NAME }}
          path: apk-output/*.apk
          retention-days: 90  # Produktions-Builds l√§nger aufbewahren
      
      - name: Commit-Informationen auslesen
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git log -1 --format=%cd --date=iso-strict)" >> $GITHUB_ENV
          
          # Vollst√§ndige Commit-Nachricht mit Zeilenumbr√ºchen und Emojis (UTF-8)
          {
            echo 'COMMIT_MSG<<EOF'
            git -c core.quotepath=false log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_ENV
      
      - name: Create Production Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: "üìù Simple Notes Sync v${{ env.VERSION_NAME }}"
          files: apk-output/*.apk
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## üì¶ Downloads
            
            | Variante | Datei | Info |
            |----------|-------|------|
            | **üèÜ Empfohlen** | `simple-notes-sync-v${{ env.VERSION_NAME }}-standard-universal.apk` | Funktioniert auf allen Android-Geraeten |
            | Modern (2018+) | `simple-notes-sync-v${{ env.VERSION_NAME }}-standard-arm64-v8a.apk` | Kleinere Dateigr√∂√üe fuer 64-bit Ger√§te |
            | Aelter (<2018) | `simple-notes-sync-v${{ env.VERSION_NAME }}-standard-armeabi-v7a.apk` | Fuer 32-bit ARM Ger√§te |
            | F-Droid Universal | `simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-universal.apk` | Fuer F-Droid Store |
            | F-Droid ARM64 | `simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-arm64-v8a.apk` | F-Droid 64-bit |
            | F-Droid ARMv7 | `simple-notes-sync-v${{ env.VERSION_NAME }}-fdroid-armeabi-v7a.apk` | F-Droid 32-bit |
            
            üí° **Nicht sicher?** ‚Üí Nimm die **Universal** APK!
            
            ---
            
            ## üìã Aenderungen
            
            ${{ env.COMMIT_MSG }}
            
            ---
            
            ## üìä Build-Info
            
            - **Version:** ${{ env.VERSION_NAME }} (Code: ${{ env.BUILD_NUMBER }})
            - **Datum:** ${{ env.COMMIT_DATE }}
            - **Commit:** ${{ env.SHORT_SHA }}
            
            ---
            
            **[ÔøΩ Dokumentation](https://github.com/inventory69/simple-notes-sync/blob/main/QUICKSTART.md)** ¬∑ **[üêõ Issue melden](https://github.com/inventory69/simple-notes-sync/issues)**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
