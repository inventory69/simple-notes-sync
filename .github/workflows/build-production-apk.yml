name: Build Android Production APK

on:
  push:
    branches: [ main ]  # Trigger on push to main branch
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build Production APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Generate Production version number
        run: |
          # Extract version from build.gradle.kts
          VERSION_NAME=$(grep "versionName = " android/app/build.gradle.kts | sed 's/.*versionName = "\(.*\)".*/\1/')
          VERSION_CODE=$(grep "versionCode = " android/app/build.gradle.kts | sed 's/.*versionCode = \([0-9]*\).*/\1/')
          
          # Use extracted version for F-Droid compatibility
          BUILD_NUMBER="$VERSION_CODE"
          
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "VERSION_TAG=v$VERSION_NAME" >> $GITHUB_ENV
          
          echo "üöÄ Building version: $VERSION_NAME (code: $BUILD_NUMBER)"
      
      - name: Verify build.gradle.kts version
        run: |
          echo "‚úÖ Using version from build.gradle.kts:"
          grep -E "versionCode|versionName" android/app/build.gradle.kts
      
      - name: Setup Android signing
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/simple-notes-release.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=simple-notes-release.jks" >> android/key.properties
          echo "‚úÖ Signing configuration created"
      
      - name: Build Production APK (Release)
        run: |
          cd android
          ./gradlew assembleStandardRelease --no-daemon --stacktrace
      
      - name: Copy APK variants to root with version names
        run: |
          mkdir -p apk-output
          
          # Universal APK
          cp android/app/build/outputs/apk/standard/release/app-standard-universal-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-universal.apk
          
          # ARM64 APK
          cp android/app/build/outputs/apk/standard/release/app-standard-arm64-v8a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-arm64-v8a.apk
          
          # ARMv7 APK
          cp android/app/build/outputs/apk/standard/release/app-standard-armeabi-v7a-release.apk \
             apk-output/simple-notes-sync-v${{ env.VERSION_NAME }}-armeabi-v7a.apk
          
          echo "‚úÖ APK files prepared:"
          ls -lh apk-output/
      
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: simple-notes-sync-apks-v${{ env.VERSION_NAME }}
          path: apk-output/*.apk
          retention-days: 90  # Keep production builds longer
      
      - name: Get commit info
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "COMMIT_DATE=$(git log -1 --format=%cd --date=iso-strict)" >> $GITHUB_ENV
          
          # Get full commit message preserving newlines and emojis (UTF-8)
          {
            echo 'COMMIT_MSG<<EOF'
            git -c core.quotepath=false log -1 --pretty=%B
            echo 'EOF'
          } >> $GITHUB_ENV
      
      - name: Create Production Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: "üìù Simple Notes Sync v${{ env.VERSION_NAME }} (Produktions-Release)"
          files: apk-output/*.apk
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            # üìù Produktions-Release: Simple Notes Sync v${{ env.VERSION_NAME }}
            
            ## Build-Informationen
            
            - **Version:** ${{ env.VERSION_NAME }}+${{ env.BUILD_NUMBER }}
            - **Build-Datum:** ${{ env.COMMIT_DATE }}
            - **Commit:** ${{ env.SHORT_SHA }}
            - **Umgebung:** üü¢ **PRODUKTION**
            
            ---
            
            ## üìã √Ñnderungen
            
            ${{ env.COMMIT_MSG }}
            
            ---
            
            ## üì¶ Download & Installation
            
            ### Welche APK soll ich herunterladen?
            
            | Dein Ger√§t | Lade diese APK herunter | Gr√∂√üe | Kompatibilit√§t |
            |------------|------------------------|-------|----------------|
            | ü§∑ Nicht sicher? | `simple-notes-sync-v${{ env.VERSION_NAME }}-universal.apk` | ~5 MB | Funktioniert auf allen Ger√§ten |
            | Modern (2018+) | `simple-notes-sync-v${{ env.VERSION_NAME }}-arm64-v8a.apk` | ~3 MB | Schneller, kleiner |
            | √Ñltere Ger√§te | `simple-notes-sync-v${{ env.VERSION_NAME }}-armeabi-v7a.apk` | ~3 MB | √Ñltere ARM-Chips |
            
            ### Installationsschritte
            1. Lade die passende APK aus den Assets unten herunter
            2. Aktiviere "Installation aus unbekannten Quellen" in den Android-Einstellungen
            3. √ñffne die heruntergeladene APK-Datei
            4. Folge den Installationsanweisungen
            5. Konfiguriere die WebDAV-Einstellungen in der App
            
            ---
            
            ## ‚öôÔ∏è Funktionen
            
            - ‚úÖ Automatische WebDAV-Synchronisation alle 30 Minuten (~0,4% Akku/Tag)
            - ‚úÖ Intelligente Gateway-Erkennung (automatische Heimnetzwerk-Erkennung)
            - ‚úÖ Material Design 3 Oberfl√§che
            - ‚úÖ Datenschutzorientiert (kein Tracking, keine Analysen)
            - ‚úÖ Offline-First Architektur
            
            ---
            
            ## üîÑ Update von vorheriger Version
            
            Installiere diese APK einfach √ºber die bestehende Installation - alle Daten und Einstellungen bleiben erhalten.
            
            ---
            
            ## üì± Obtanium - Auto-Update App
            
            Erhalte automatische Updates mit [Obtanium](https://github.com/ImranR98/Obtanium/releases/latest).
            
            **Einrichtung:**
            1. Installiere Obtanium √ºber den Link oben
            2. F√ºge die App mit dieser URL hinzu: `https://github.com/dettmersLiq/simple-notes-sync`
            3. Aktiviere Auto-Updates
            
            ---
            
            ## üÜò Support
            
            Bei Problemen oder Fragen √∂ffne bitte ein Issue auf GitHub.
            
            ---
            
            ## üîí Datenschutz & Sicherheit
            
            - Alle Daten werden √ºber deinen eigenen WebDAV-Server synchronisiert
            - Keine Drittanbieter-Analysen oder Tracking
            - Keine Internet-Berechtigungen au√üer f√ºr WebDAV-Sync
            - Alle Synchronisationsvorg√§nge verschl√ºsselt (HTTPS)
            - Open Source - pr√ºfe den Code selbst
            
            ---
            
            ## üõ†Ô∏è Erstellt mit
            
            - **Sprache:** Kotlin
            - **UI:** Material Design 3
            - **Sync:** WorkManager + WebDAV
            - **Target SDK:** Android 16 (API 36)
            - **Min SDK:** Android 8.0 (API 26)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
